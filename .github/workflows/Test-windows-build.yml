name: Build on Windows test

on: 
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-2022
    env: 
        THIRDPARTY_HOME: C:/Users/runneradmin/thirdparty
        CMAKE_HOME: C:/Program Files/CMake
        CMAKE_BIN: C:/Program Files/CMake/bin/cmake.exe
        SNAPPY_HOME: C:/Users/runneradmin/thirdparty/snappy-1.1.8
        SNAPPY_INCLUDE: C:/Users/runneradmin/thirdparty/snappy-1.1.8;C:/Users/circleci/thirdparty/snappy-1.1.8/build
        SNAPPY_LIB_DEBUG: C:/Users/runneradmin/thirdparty/snappy-1.1.8/build/Debug/snappy.lib
        CMAKE_GENERATOR: Visual Studio 17 2022
        CODE_HOME: C:/Users/runneradmin/code
    steps:
      - uses: actions/checkout@v3
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin' # See 'Supported distributions' for available options
          java-version: '8'
        
      #- name: update the PATH
      #  run: |
      #    echo "C:\Program Files\Microsoft Visual Studio\2022\Community\MSBuild\Current\Bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append    
        
      - name: Add msbuild to PATH
        uses: microsoft/setup-msbuild@v1.1    

      - name: install snappy 
        shell: powershell
        run: |
            echo $env:CODE_HOME
            dir C:/Users/
            dir C:/Users/runneradmin
            mkdir $env:CODE_HOME
            cd $env:CODE_HOME
            curl https://github.com/google/snappy/archive/refs/tags/1.1.9.zip -o 1.1.9.zip
            echo "dir 11"
            dir
            Expand-Archive -Path 1.1.9.zip -DestinationPath snappy-tmp
            echo "dir 22"
            dir
            echo "dir 33"
            dir snappy-tmp 
            mv .\snappy-tmp\snappy-1.1.9\ .
            rmdir .\snappy-tmp\
            cd .\snappy-1.1.9\
            mkdir build
            cd .\build\
            cmake -G "Visual Studio 17 2022" -A x64 -DCMAKE_GENERATOR_PLATFORM=x64 -DSNAPPY_BUILD_TESTS=OFF -DSNAPPY_BUILD_BENCHMARKS=OFF ..
            msbuild Snappy.sln /p:Configuration=Debug /p:Platform=x64
            msbuild Snappy.sln /p:Configuration=Release /p:Platform=x64        

      - name: install third-party  
        shell: powershell
        run: |                  
            echo "Installing CMake..."
            choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y
            echo "Running mkdir 111"
            echo ""
            mkdir "$Env:THIRDPARTY_HOME"
            cd $Env:THIRDPARTY_HOME
            echo "Building Snappy dependency..."
            curl https://github.com/google/snappy/archive/refs/tags/1.1.8.zip -O snappy-1.1.8.zip
            unzip -q snappy-1.1.8.zip
            cd snappy-1.1.8
            mkdir build
            cd build
            & $Env:CMAKE_BIN -G "$Env:CMAKE_GENERATOR" ..                        
            echo "show path"
            echo $Env:Path
            echo "list files"
            #     dir C:\Program Files\Microsoft Visual Studio\2022\Community\MSBuild\Current\Bin
            echo "run msbuild"
            msbuild.exe Snappy.sln -maxCpuCount -property:Configuration=Debug -property:Platform=x64
    
     
      - name: "Build RocksDB"      
        run: |
            mkdir build
            cd build
            #& $Env:CMAKE_BIN -G "$Env:CMAKE_GENERATOR" -DCMAKE_BUILD_TYPE=Debug -DOPTDBG=1 -DPORTABLE=1 -DSNAPPY=1 -DJNI=1 ..
            & $Env:CMAKE_BIN -G "$Env:CMAKE_GENERATOR" -DCMAKE_BUILD_TYPE=Debug -DCMAKE_CXX_STANDARD=20 -A x64 -DJNI=1 -DGFLAGS=1 -DOPTDBG=1 -DPORTABLE=1 -DSNAPPY=1 -DJNI=1 -DSNAPPY=1 -DLZ4=1 -DZLIB=1 -DZSTD=1 -DXPRESS=1 -DFAIL_ON_WARNINGS=0 ..
            cd ..
            echo "Building with VS version: $Env:CMAKE_GENERATOR"
            msbuild build/speedb.sln /p:Configuration=Release /t:speedbjni-shared
            #msbuild.exe build/rocksdb.sln -maxCpuCount -property:Configuration=Debug -property:Platform=x64
            #msbuild.exe build/speedb.sln -maxCpuCount -property:Configuration=Debug -property:Platform=x64
     
      - name: Test RocksDB
        shell: powershell
        run: |          
          build_tools\run_ci_db_test.ps1 -SuiteRun arena_test,db_basic_test,db_test,db_test2,db_merge_operand_test,bloom_test,c_test,coding_test,crc32c_test,dynamic_bloom_test,env_basic_test,env_test,hash_test,random_test -Concurrency 16
